# Техническая документация - МФФ 3D Навигация

## Архитектура проекта

### Технологический стек
- **Frontend Framework**: React 18 + TypeScript
- **3D Engine**: Three.js + React Three Fiber
- **State Management**: Zustand
- **Styling**: Tailwind CSS
- **Build Tool**: Vite
- **Hosting**: Firebase Hosting
- **Version Control**: Git + GitHub

### Структура проекта
```
forum-nav-app5/
├── public/                    # Статические файлы
│   ├── logo.ico              # Логотип SDVT
│   ├── SM_MFF.glb            # 3D модель форума
│   ├── atmosphere/           # Атмосферные эффекты
│   ├── textures/             # Текстуры
│   └── *.hdr                 # HDRI окружения
├── src/
│   ├── components/           # React компоненты
│   │   ├── Scene3D.tsx       # Основная 3D сцена
│   │   ├── UIOverlay.tsx     # Оверлей интерфейса
│   │   ├── BottomNav.tsx     # Нижнее меню
│   │   ├── FullscreenToggle.tsx # Кнопка fullscreen
│   │   ├── ZoneDetailOverlay.tsx # Детали зоны
│   │   ├── EventsPanel.tsx   # Панель событий
│   │   ├── ZonesPanel.tsx    # Панель зон
│   │   ├── SettingsPanel.tsx # Настройки
│   │   ├── MiniMap.tsx       # Мини-карта
│   │   ├── FPSCounter.tsx    # Счетчик FPS
│   │   └── ...               # Другие компоненты
│   ├── store/
│   │   └── appStore.ts       # Zustand store
│   ├── data/
│   │   └── mockData.ts       # Данные зон и событий
│   ├── utils/
│   │   └── navigation.ts     # Утилиты навигации
│   ├── hooks/                # Custom hooks
│   ├── types/                # TypeScript типы
│   ├── styles/               # Стили
│   ├── App.tsx               # Главный компонент
│   └── main.tsx              # Точка входа
├── dist/                     # Собранное приложение
├── .firebase/                # Firebase конфигурация
├── firebase.json             # Firebase настройки
├── .firebaserc               # Firebase проекты
├── package.json              # Зависимости
├── vite.config.ts            # Vite конфигурация
└── tailwind.config.js        # Tailwind конфигурация
```

## Основные компоненты

### 1. Scene3D.tsx
**Назначение**: Основная 3D сцена с Three.js

**Функции:**
- Рендеринг 3D модели
- Управление камерой (Orbit/Orthographic/Perspective)
- Освещение (Directional, Hemisphere, HDRI)
- Тени (PCF Soft Shadows, Contact Shadows)
- Обработка resize окна
- Fullscreen режим

**Оптимизации:**
- Pixel ratio ограничен до 2x
- Shadow map: 1024x1024
- Contact shadows: 256 resolution
- SSAO отключен по умолчанию

### 2. UIOverlay.tsx
**Назначение**: Контейнер для всех UI элементов

**Управляет:**
- Видимостью панелей
- Состоянием fullscreen
- Backdrop overlay
- Позиционированием элементов

### 3. BottomNav.tsx
**Назначение**: Нижнее меню навигации

**Кнопки:**
- HOME: Сброс камеры
- ЗОНЫ: Панель зон
- РАСПИСАНИЕ: События
- POI: Точки интереса
- ОСВЕЩЕНИЕ: Настройки света
- НАСТРОЙКИ: Панель настроек

**Особенности:**
- Анимация расширения при hover
- Адаптивный дизайн
- Glass morphism эффект

### 4. FullscreenToggle.tsx
**Назначение**: Кнопка управления UI в fullscreen

**Функции:**
- Показывается только в fullscreen
- Переключает видимость UI
- Меняет иконку (меню/крестик)
- Независимый рендеринг (z-index: 99999)

### 5. ZoneDetailOverlay.tsx
**Назначение**: Детальная информация о зоне

**Функции:**
- Показ информации о зоне
- Список событий (текущие/будущие/прошедшие)
- Построение маршрута
- Отмена маршрута

### 6. EventsPanel.tsx
**Назначение**: Панель событий с фильтрами

**Функции:**
- Фильтрация (все/избранное/сейчас)
- Добавление в избранное
- Настройка напоминаний
- Навигация к месту события

### 7. MiniMap.tsx
**Назначение**: Мини-карта с позицией

**Функции:**
- 2D проекция 3D координат
- Поворот на 90° против часовой
- Показ зон, маршрута, позиции
- Пульсирующий маркер пользователя

### 8. FPSCounter.tsx
**Назначение**: Счетчик производительности

**Функции:**
- Подсчет FPS через requestAnimationFrame
- Цветовая индикация
- Обновление каждую секунду

## State Management (Zustand)

### Основные состояния:

```typescript
interface AppState {
  // Навигация
  currentRoute: Route | null
  lastRouteDestination: [number, number, number] | null
  
  // UI
  activePanel: UIPanel
  activeBottomPanel: string | null
  isFullscreen: boolean
  showUIInFullscreen: boolean
  showFPS: boolean
  showMiniMap: boolean
  showPOI: boolean
  
  // Камера
  viewMode: ViewMode
  cameraPosition: [number, number, number] | null
  
  // Данные
  zones: Zone[]
  events: Event[]
  selectedZone: Zone | null
  selectedEvent: Event | null
  
  // Настройки
  hdriFile: string
  hdriIntensity: number
  bloomIntensity: number
  ssaaoEnabled: boolean
  // ... и другие
}
```

## Система маршрутов

### Логика цепочки маршрутов:

```typescript
// 1. Первый маршрут
const startPosition = userLocation.position // Точка А
const route = calculateRoute(startPosition, destination)
setLastRouteDestination(destination)

// 2. Следующий маршрут
const startPosition = lastRouteDestination || userLocation.position
const route = calculateRoute(startPosition, newDestination)
setLastRouteDestination(newDestination)

// 3. Отмена
setRoute(null)
setLastRouteDestination(null) // Сброс цепочки
```

### Визуализация маршрута:
- Линия от старта до финиша
- Пульсирующий маркер назначения
- Отображение на мини-карте

## Система освещения

### Типы света:
1. **HDRI Environment**: Окружающее освещение
2. **Directional Light**: Основной направленный свет с тенями
3. **Hemisphere Light**: Естественное освещение неба/земли

### Настройки теней:
```typescript
shadowMap: {
  enabled: true,
  type: THREE.PCFSoftShadowMap,
  size: [1024, 1024]
}

contactShadows: {
  resolution: 256,
  opacity: 0.3,
  blur: 2
}
```

## Оптимизация производительности

### Реализованные оптимизации:

1. **Pixel Ratio**: Ограничен до 2x
   ```typescript
   dpr={[1, 2]}
   ```

2. **Тени**: Уменьшено разрешение
   - Shadow map: 4096 → 1024
   - Contact shadows: 1024 → 256

3. **SSAO**: Отключен по умолчанию
   ```typescript
   ssaaoEnabled: false
   ```

4. **Multisampling**: Снижен с 8 до 2
   ```typescript
   multisampling={2}
   ```

5. **Canvas**: Оптимизированные настройки
   ```typescript
   gl={{
     alpha: false,
     preserveDrawingBuffer: false,
     powerPreference: 'high-performance'
   }}
   ```

## Fullscreen режим

### Реализация:

```typescript
// Применяется к root элементу, не к canvas
const root = document.getElementById('root')
root.requestFullscreen()

// Отслеживание состояния
document.addEventListener('fullscreenchange', () => {
  const isFullscreen = !!document.fullscreenElement
  setIsFullscreen(isFullscreen)
})
```

### Управление UI:
- UI скрывается при входе в fullscreen
- Кнопка toggle рендерится независимо в App.tsx
- Высокий z-index (99999) для видимости

## Адаптивность

### Viewport:
```css
html, body {
  height: 100vh;
  height: 100dvh; /* Dynamic viewport для мобильных */
}
```

### Safe Area:
```css
padding-bottom: max(20px, calc(env(safe-area-inset-bottom) + 12px))
```

### Resize обработка:
```typescript
window.addEventListener('resize', () => {
  renderer.setSize(window.innerWidth, window.innerHeight)
  camera.aspect = window.innerWidth / window.innerHeight
  camera.updateProjectionMatrix()
})
```

## Стилизация

### Glass Morphism эффект:
```css
background: rgba(40, 40, 40, 0.6);
backdrop-filter: blur(12px) saturate(180%) brightness(0.7);
border: 1px solid rgba(255,255,255,0.15);
box-shadow: inset 0 1px 0 0 rgba(255,255,255,0.1),
            inset 0 -1px 0 0 rgba(0,0,0,0.2),
            0 8px 32px rgba(0,0,0,0.4);
```

### Золотая тема:
```css
--gold-primary: #D4AF37;
--gold-light: #F4E8C1;
--gold-dark: #8B7355;
```

## Сборка и деплой

### Команды:

```bash
# Разработка
npm run dev

# Сборка
npm run build

# Деплой на Firebase
firebase deploy

# Создание бекапа
.\create-backup.ps1
```

### Процесс деплоя:
1. `npm run build` - сборка в dist/
2. `firebase deploy` - загрузка на хостинг
3. Автоматическая инвалидация кеша
4. Доступно на https://forum-navigator.web.app

## Файлы данных

### zones (mockData.ts)
```typescript
{
  id: string
  name: string
  description: string
  type: 'conference' | 'exhibition' | 'food' | ...
  position: [x, y, z]
  color: string
}
```

### events (mockData.ts)
```typescript
{
  id: string
  title: string
  zoneId: string
  startTime: Date
  endTime: Date
  description: string
}
```

## Импорт событий

### CSV формат:
```csv
title,zone,date,startTime,endTime,description
"Название","Зона ID","2026-02-15","09:00","10:30","Описание"
```

### Скрипты:
- `convert_events_csv.js` - конвертация CSV в JSON
- `import_events.js` - импорт в приложение

## Blender интеграция

### Скрипты для Blender:
- `blender_export_all_cameras.py` - экспорт всех камер
- `blender_export_poi_cameras.py` - экспорт POI камер
- `blender_create_poi_cameras.py` - создание POI камер
- `blender_extract_zones.py` - извлечение зон из модели

### Экспорт модели:
1. Открыть модель в Blender
2. File → Export → glTF 2.0
3. Настройки: Include → Selected Objects
4. Сохранить как SM_MFF.glb

## Troubleshooting

### Проблема: Низкий FPS
**Решение:**
- Отключить SSAO
- Уменьшить разрешение теней
- Снизить multisampling
- Отключить bloom

### Проблема: Не работает fullscreen
**Решение:**
- Проверить что fullscreen применяется к root
- Убедиться что кнопка имеет высокий z-index
- Проверить обработчик fullscreenchange

### Проблема: UI не скрывается в fullscreen
**Решение:**
- Проверить состояние isFullscreen в store
- Убедиться что shouldShowUI правильно вычисляется
- Проверить что FullscreenToggle рендерится в App.tsx

## Версионирование

**Текущая версия**: 1.2.0

### История версий:
- 1.0.0 - Базовая функциональность
- 1.1.0 - Добавлены события и маршруты
- 1.2.0 - Fullscreen, FPS, оптимизация, цепочка маршрутов

---
**Дата обновления**: Февраль 2026  
**Разработчик**: SDVT
